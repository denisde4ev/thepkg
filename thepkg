#!/bin/sh
: "{THEPKG_PREFIX?}" # still experimental, dont use it on real root '/'

set -ue
<<:
"${THEPKG_PREFIX=/}"
"${THEPKG_DBPATH=$THEPKG_PREFIX/var/db/thepkg}"
:

log() { printf ' -> %s\n' "$@"; }
err() { i=$?; printf ' x> %s\n' "$@" >&2; exit $i; }


unset pkgname
case $1 in
add)
	pkgname=$(
		tar tf "$2" | \
		grep -x "${THEPKG_DBPATH#"$THEPKG_PREFIX/"}"'/[^/]*/version'
	) || err "Not a valid thepkg package"
	pkgname=${pkgname%/version}
	pkgname=${pkgname##*/}

	[ ! -e "$THEPKG_DBPATH/${pkgname:?}" ] || \
		err "The pkg '$pkgname' is already installed"

	log "Extracting the pkg '$pkgname'..."
	{
		mkdir -p "$THEPKG_DBPATH/$pkgname"
		tar xvf "$2" -C "$THEPKG_PREFIX" | \
		sort -r >"$THEPKG_DBPATH/$pkgname"/manifest
	} || err "Failed to install the pkg '$pkgname'!"
	;;
del)
	cd "$THEPKG_PREFIX" || exit
	log "Removing the pkg '$2'..."
	while IFS= read -r file; do
		case $file in
		*/) rmdir "$file" 2>/dev/null||:;;
		*) rm "$file";;
		esac
	done <"$THEPKG_DBPATH"/"$2"/manifest
	rm "$THEPKG_DBPATH"/"$2"/manifest
	rmdir "$THEPKG_DBPATH"/"$2"
esac
