#!/bin/sh

# : "${THEPKG_PREFIX=/data/data/com.termux/files/home/0/thepkg/test}"
: "${THEPKG_PREFIX:=./opt}"
: "${THEPKG_DBPATH:=$THEPKG_PREFIX/../var/db/thepkg}"

set -e

[ -d "${THEPKG_PREFIX:?}" ] || mkdir -pv "$THEPKG_PREFIX"
[ -d "${THEPKG_DBPATH:?}" ] || mkdir -pv "$THEPKG_DBPATH"

log() { printf %s\\n " -> $1"; }
err() { printf %s\\n >&2 " x> $1"; exit ${2-2}; }


# args parsing:
case $1 in
	-h|--help) printf %s\\n "Usage: ${0##*/} <add|del> </path/to/thepkgname@v1.0.0.tar.qz | thepkgname@v1.0.0.tar | thepkgname>"; exit;;
	'') err "specify action add/del";;
esac
case $1 in
	add|del) action=$1;;
	*)err "use --help";;
esac
shift
thepkgname=${1##*/};
unset tar_file
case $1 in
'')
	err "missing or empty thepkgname";;
*/*|*.tar|*.tar.*)
	# note: for `thepkg del thepkgname.tar`
	# will not look at the tar file at all,
	# just detects the name from the name and removes it
	tar_file=$1
	thepkgname=${thepkgname%%".tar"*}
	thepkgname=${thepkgname%%"@"*}
;;
esac


case $action in
add)
	[ ! -e "$THEPKG_DBPATH/$thepkgname" ] || {
		err "The pkg '$thepkgname' is already installed" 2
	}
	log "Extracting the pkg '$thepkgname'..."
	mkdir -v "$THEPKG_DBPATH/$thepkgname"
	# tar -k    donâ€™t replace existing files, treat them as errors
	tar -axvf "${tar_file-"-"}" -k -C "$THEPKG_PREFIX" | tee /dev/stderr | \
	sort -r > "$THEPKG_DBPATH/$thepkgname"/manifest

	# test -s   exists and has a size greater than zero
	[ -s "$THEPKG_DBPATH/$thepkgname"/manifest ] || {
		# detect when went wrong
		# reason: `tar` is ran in pipe
		# and exit status is lost in POSIX sh
		# then exit status would be 0

		printf ' x> %s\n' >&2 \
			"Extracding the pkg went wrong." \
			"To remove the empty pkg installed," \
			"  please run: ${0##*/} del '$thepkgname'" \
		;
		exit 3
	}
	;;
del)
	[ -e "$THEPKG_DBPATH/$thepkgname" ] || {
		err "The pkg '$thepkgname' is not installed" 2
	}
	log "Removing the pkg '$thepkgname'..."
	(
		cd "$THEPKG_PREFIX" || exit
		while IFS= read -r file; do
			case $file in
				*/) rmdir -v "$file" 2>/dev/null||:;;
				*) rm -v "$file";;
			esac
		done
	) < "$THEPKG_DBPATH/$thepkgname"/manifest
	rm -v "$THEPKG_DBPATH/$thepkgname"/manifest
	rmdir -v "$THEPKG_DBPATH/$thepkgname"
	;;
*) err "use --help";;
esac
