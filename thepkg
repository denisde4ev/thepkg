#!/bin/sh

# : "${THEPKG_PREFIX=/data/data/com.termux/files/home/0/thepkg/test}"
: "${THEPKG_PREFIX:=./opt}"
: "${THEPKG_DBPATH:=$THEPKG_PREFIX/../var/db/thepkg}"

## config end ##
set -ue

log() { printf %s\\n " -> $*"; }
err() { printf %s\\n >&2 " x> $*"; exit ${2-2}; }


case ${1-"please specify action add/del"} in
add)
	case ${1-} in
		--name=*) thepkgname=${1#--name=}; shift;;
		*) case $2 in */*@*.tar*) thepkgname=${2##*/}; thepkgname=${thepkgname%%"@"*};; *)
	esac
	[ ! -e "$THEPKG_DBPATH/${thepkgname:?"missing or empty thepkgname, use --name=THEPKGNAME"}" ] || \
		err "The pkg '$thepkgname' is already installed" $?
	mkdir -v "$THEPKG_DBPATH/$thepkgname"
	log "Extracting the pkg '$thepkgname'..."
	tar xvf "${2:?"please specify path"}" -k -C "$THEPKG_PREFIX" | sort -r >"$THEPKG_DBPATH/$thepkgname"/manifest
	# -k  donâ€™t replace existing files, treat them as errors
	;;
del)
	thepkgname=${2:-"missing or empty thepkgname"}
	cd "$THEPKG_PREFIX" || exit
	log "Removing the pkg '$thepkgname'..."
	while IFS= read -r file; do
		case $file in
			*/) rmdir "$file" 2>/dev/null||: ;;
			*) rm "$file";;
		esac
	done <"$THEPKG_DBPATH/$thepkgname"/manifest
	rm "$THEPKG_DBPATH/$thepkgname"/manifest
	rmdir "$THEPKG_DBPATH/$thepkgname"
	;;
--help) log "Usage ${0##*/} [--name=THEPKGNAME] <add/del> <file@ver.tar/THEPKGNAME>";;
*) err "use --help";;
esac
